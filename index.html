<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Rescue HQ App</title>
    
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Leaflet CSS & JS (For the Map) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- MQTT Library (Paho) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body { background-color: #f3f4f6; }
        #map { height: 100%; width: 100%; z-index: 0; }
        .map-container { height: 60vh; width: 100%; position: relative; }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        /* Custom Map Markers */
        .custom-div-icon { background: transparent; border: none; }
        .marker-pin {
            width: 30px; height: 30px; border-radius: 50% 50% 50% 0;
            position: absolute; transform: rotate(-45deg);
            left: 50%; top: 50%; margin: -15px 0 0 -15px;
            box-shadow: 0px 3px 5px rgba(0,0,0,0.3);
        }
        .marker-pin::after {
            content: ''; width: 14px; height: 14px; margin: 8px 0 0 8px;
            background: #fff; position: absolute; border-radius: 50%;
        }
        .marker-red { background: #dc2626; }
        .marker-orange { background: #f97316; }
        .marker-icon {
            position: absolute; width: 100%; font-size: 16px;
            line-height: 30px; text-align: center; color: white;
            top: -35px; font-weight: bold; text-shadow: 1px 1px 2px black;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- CONFIGURATION ---
        const MQTT_BROKER = "broker.hivemq.com";
        const MQTT_PORT = 8884; // Secure WSS for HTTPS compatibility
        const TOPIC_ALERT = "fyp/sos_alert";
        const TOPIC_RESPONSE = "fyp/sos_response";

        // Helper to create custom map icons
        const createCustomIcon = (status) => {
            const colorClass = status === 'LAST_KNOWN' ? 'marker-orange' : 'marker-red';
            return L.divIcon({
                className: 'custom-div-icon',
                html: `<div class="marker-pin ${colorClass}"></div><i class="fas fa-exclamation marker-icon"></i>`,
                iconSize: [30, 42],
                iconAnchor: [15, 42],
                popupAnchor: [0, -35]
            });
        };

        function App() {
            const [client, setClient] = useState(null);
            const [isConnected, setIsConnected] = useState(false);
            const [alerts, setAlerts] = useState([]);
            const [activeTab, setActiveTab] = useState('dashboard');
            const [statusMsg, setStatusMsg] = useState("Connecting to HQ Network...");
            
            const mapRef = useRef(null);
            const mapInstanceRef = useRef(null);
            const markersRef = useRef({});

            // --- MQTT SETUP ---
            useEffect(() => {
                const clientId = "RescueHQ-App-" + Math.random().toString(16).substr(2, 8);
                const mqttClient = new Paho.MQTT.Client(MQTT_BROKER, MQTT_PORT, clientId);

                mqttClient.onConnectionLost = (responseObject) => {
                    if (responseObject.errorCode !== 0) {
                        setStatusMsg("Connection Lost: " + responseObject.errorMessage);
                        setIsConnected(false);
                    }
                };

                mqttClient.onMessageArrived = (message) => {
                    console.log("Msg arrived:", message.payloadString);
                    try {
                        const data = JSON.parse(message.payloadString);
                        handleNewAlert(data);
                    } catch (e) {
                        console.log("Not JSON, ignoring.");
                    }
                };

                mqttClient.connect({
                    onSuccess: () => {
                        setIsConnected(true);
                        setStatusMsg("Online - Listening for Signals");
                        mqttClient.subscribe(TOPIC_ALERT);
                    },
                    onFailure: (e) => {
                        setStatusMsg("Connection Failed. Retrying...");
                        console.log(e);
                    },
                    useSSL: true
                });

                setClient(mqttClient);
                return () => { if(mqttClient.isConnected()) mqttClient.disconnect(); }
            }, []);

            // --- HANDLE NEW ALERT ---
            const handleNewAlert = (data) => {
                // Default status logic
                let currentStatus = data.status || 'CRITICAL';
                if (data.lat === 0 && data.lon === 0) currentStatus = 'NO_GPS';

                const newAlert = {
                    ...data,
                    status: currentStatus,
                    time: new Date().toLocaleTimeString()
                };

                setAlerts(prev => {
                    const existing = prev.filter(a => a.id !== newAlert.id);
                    return [newAlert, ...existing];
                });

                // Update Map
                if (mapInstanceRef.current && currentStatus !== 'NO_GPS') {
                    const { id, lat, lon } = newAlert;
                    
                    if (markersRef.current[id]) {
                        mapInstanceRef.current.removeLayer(markersRef.current[id]);
                    }

                    const marker = L.marker([lat, lon], { icon: createCustomIcon(currentStatus) }).addTo(mapInstanceRef.current);
                    
                    let popupMsg = `<b>${id}</b><br>Status: ${currentStatus}<br>${newAlert.time}`;
                    marker.bindPopup(popupMsg).openPopup();
                    markersRef.current[id] = marker;
                    
                    mapInstanceRef.current.setView([lat, lon], 15);
                }
            };

            // --- MAP INITIALIZATION ---
            useEffect(() => {
                if (activeTab === 'map' && !mapInstanceRef.current && mapRef.current) {
                    const map = L.map(mapRef.current).setView([4.2105, 101.9758], 6);
                    
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '&copy; OpenStreetMap contributors'
                    }).addTo(map);

                    mapInstanceRef.current = map;

                    // Re-add markers
                    alerts.forEach(alert => {
                        if (alert.status !== 'NO_GPS') {
                            const { id, lat, lon, status } = alert;
                            const marker = L.marker([lat, lon], { icon: createCustomIcon(status) }).addTo(map);
                            marker.bindPopup(`<b>${id}</b><br>Status: ${status}<br>${alert.time}`);
                            markersRef.current[id] = marker;
                        }
                    });
                }
            }, [activeTab]);

            // --- SEND CONFIRMATION ---
            const sendHelp = (targetId) => {
                if (!client || !isConnected) return;
                
                const message = new Paho.MQTT.Message("CONFIRM_HELP");
                message.destinationName = TOPIC_RESPONSE;
                client.send(message);
                
                alert(`Confirmation sent to ${targetId}!`);
                
                setAlerts(prev => prev.map(a => 
                    a.id === targetId ? { ...a, status: 'HELP SENT' } : a
                ));
            };

            const getStatusColor = (status) => {
                if (status === 'NO_GPS') return 'bg-gray-100 border-gray-500 text-gray-700';
                if (status === 'LAST_KNOWN') return 'bg-orange-50 border-orange-500 text-orange-800';
                if (status === 'HELP SENT') return 'bg-green-50 border-green-500 text-green-800';
                return 'bg-red-50 border-red-600 text-red-900';
            };

            const getBadgeColor = (status) => {
                if (status === 'NO_GPS') return 'bg-gray-600 text-white';
                if (status === 'LAST_KNOWN') return 'bg-orange-500 text-white';
                if (status === 'HELP SENT') return 'bg-green-600 text-white';
                return 'bg-red-600 text-white';
            };

            // --- RENDER ---
            return (
                <div className="flex flex-col h-screen bg-gray-100 max-w-md mx-auto shadow-2xl overflow-hidden">
                    
                    {/* APP HEADER */}
                    <div className="bg-slate-800 text-white p-4 pt-8 shadow-md z-10">
                        <div className="flex justify-between items-center">
                            <h1 className="text-xl font-bold tracking-wider"><i className="fas fa-satellite-dish mr-2"></i>RESCUE HQ</h1>
                            <div className="flex items-center text-xs">
                                <span className={`w-3 h-3 rounded-full mr-1 ${isConnected ? 'bg-green-400 animate-pulse' : 'bg-red-400'}`}></span>
                                {isConnected ? 'LIVE' : 'OFFLINE'}
                            </div>
                        </div>
                        <p className="text-xs text-slate-400 mt-1">{statusMsg}</p>
                    </div>

                    {/* MAIN CONTENT AREA */}
                    <div className="flex-1 overflow-hidden relative bg-white">
                        
                        {/* DASHBOARD TAB */}
                        {activeTab === 'dashboard' && (
                            <div className="h-full overflow-y-auto p-4 fade-in pb-20">
                                <h2 className="text-gray-500 text-xs font-bold uppercase mb-3 tracking-wide">Incident Log ({alerts.length})</h2>
                                
                                {alerts.length === 0 ? (
                                    <div className="text-center py-12 text-gray-300">
                                        <i className="fas fa-shield-alt text-5xl mb-4"></i>
                                        <p className="font-medium">No active incidents.</p>
                                        <p className="text-xs">System standing by.</p>
                                    </div>
                                ) : (
                                    alerts.map(alert => (
                                        <div key={alert.id} className={`border-l-4 shadow-sm rounded-r-lg p-4 mb-3 ${getStatusColor(alert.status)}`}>
                                            <div className="flex justify-between items-start">
                                                <div>
                                                    <h3 className="font-bold text-lg">{alert.id}</h3>
                                                    <p className="text-xs opacity-75"><i className="far fa-clock mr-1"></i> {alert.time}</p>
                                                    {alert.status === 'NO_GPS' ? (
                                                        <p className="text-xs font-bold mt-2 text-red-600"><i className="fas fa-exclamation-triangle mr-1"></i> UNKNOWN LOCATION</p>
                                                    ) : (
                                                        <p className="text-xs mt-1 font-mono">{alert.lat.toFixed(5)}, {alert.lon.toFixed(5)}</p>
                                                    )}
                                                </div>
                                                <span className={`px-2 py-1 rounded text-[10px] font-bold uppercase tracking-wide ${getBadgeColor(alert.status)}`}>{alert.status.replace('_', ' ')}</span>
                                            </div>
                                            
                                            <div className="mt-3 flex space-x-2">
                                                {alert.status !== 'NO_GPS' ? (
                                                    <a href={`https://www.google.com/maps/dir/?api=1&destination=${alert.lat},${alert.lon}`} target="_blank" className="flex-1 bg-white border border-gray-300 hover:bg-gray-50 text-gray-700 py-2 rounded text-center text-sm font-bold">
                                                        <i className="fas fa-location-arrow mr-1"></i> ROUTE
                                                    </a>
                                                ) : (
                                                    <button disabled className="flex-1 bg-gray-200 text-gray-400 py-2 rounded text-center text-sm font-bold cursor-not-allowed"><i className="fas fa-ban mr-1"></i> NO ROUTE</button>
                                                )}
                                                <button onClick={() => sendHelp(alert.id)} className="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-2 rounded text-center text-sm font-bold shadow-sm"><i className="fas fa-check-circle mr-1"></i> ACKNOWLEDGE</button>
                                            </div>
                                        </div>
                                    ))
                                )}
                            </div>
                        )}

                        {/* MAP TAB */}
                        <div className={`${activeTab === 'map' ? 'block' : 'hidden'} h-full w-full fade-in`}>
                            <div ref={mapRef} id="map"></div>
                            <div className="absolute bottom-6 left-4 bg-white/90 p-2 rounded shadow text-xs z-[1000]">
                                <div className="flex items-center mb-1"><span className="w-3 h-3 bg-red-600 rounded-full mr-2"></span> Critical</div>
                                <div className="flex items-center"><span className="w-3 h-3 bg-orange-500 rounded-full mr-2"></span> Last Known</div>
                            </div>
                        </div>
                    </div>

                    {/* BOTTOM NAVIGATION */}
                    <div className="bg-white border-t border-slate-200 flex justify-around py-3 pb-6 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] z-20">
                        <button onClick={() => setActiveTab('dashboard')} className={`flex flex-col items-center transition-colors ${activeTab === 'dashboard' ? 'text-slate-800' : 'text-slate-400'}`}><i className="fas fa-stream text-xl mb-1"></i><span className="text-[10px] font-bold uppercase">Feed</span></button>
                        <button onClick={() => setActiveTab('map')} className={`flex flex-col items-center transition-colors ${activeTab === 'map' ? 'text-slate-800' : 'text-slate-400'}`}><i className="fas fa-map text-xl mb-1"></i><span className="text-[10px] font-bold uppercase">Map</span></button>
                        <button onClick={() => alert("System Status: OPERATIONAL\nBattery: 100%\nGateway: CONNECTED")} className="flex flex-col items-center text-slate-400 hover:text-slate-600 transition-colors"><i className="fas fa-server text-xl mb-1"></i><span className="text-[10px] font-bold uppercase">System</span></button>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
