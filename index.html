<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Rescue HQ Command Center</title>
    
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Leaflet CSS & JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- MQTT Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* Base Reset */
        body { margin: 0; padding: 0; overflow: hidden; background-color: #f1f5f9; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        #root { height: 100vh; width: 100vw; display: flex; flex-direction: column; }
        
        /* Map Container */
        #map { height: 100%; width: 100%; z-index: 0; }
        
        /* Animations */
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Custom Map Pins */
        .custom-div-icon { background: transparent; border: none; }
        .marker-pin {
            width: 30px; height: 30px; border-radius: 50% 50% 50% 0;
            position: absolute; transform: rotate(-45deg);
            left: 50%; top: 50%; margin: -15px 0 0 -15px;
            box-shadow: 0px 3px 5px rgba(0,0,0,0.3);
        }
        .marker-pin::after {
            content: ''; width: 14px; height: 14px; margin: 8px 0 0 8px;
            background: #fff; position: absolute; border-radius: 50%;
        }
        .marker-red { background: #dc2626; }
        .marker-orange { background: #f97316; }
        .marker-icon {
            position: absolute; width: 100%; font-size: 16px;
            line-height: 30px; text-align: center; color: white;
            top: -35px; font-weight: bold; text-shadow: 1px 1px 2px black;
        }

        /* Hide scrollbar for cleaner look */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- CONFIGURATION ---
        const MQTT_BROKER = "broker.hivemq.com";
        const MQTT_PORT = 8884;
        const TOPIC_ALERT = "fyp/sos_alert";
        const TOPIC_RESPONSE = "fyp/sos_response";
        const TOPIC_SYNC = "fyp/sos_sync"; 
        
        // --- ADMIN CONFIG ---
        const ADMIN_PASSWORD = "admin123"; // Change this if you want a different password

        const createCustomIcon = (status) => {
            const colorClass = status === 'LAST_KNOWN' ? 'marker-orange' : 'marker-red';
            return L.divIcon({
                className: 'custom-div-icon',
                html: `<div class="marker-pin ${colorClass}"></div><i class="fas fa-exclamation marker-icon"></i>`,
                iconSize: [30, 42],
                iconAnchor: [15, 42],
                popupAnchor: [0, -35]
            });
        };

        // --- LOGIN SCREEN COMPONENT ---
        function LoginScreen({ onLogin }) {
            const [password, setPassword] = useState("");
            const [error, setError] = useState(false);

            const handleSubmit = (e) => {
                e.preventDefault();
                if (password === ADMIN_PASSWORD) {
                    onLogin();
                } else {
                    setError(true);
                    setPassword("");
                }
            };

            return (
                <div className="flex h-screen w-full items-center justify-center bg-slate-900 px-4">
                    <div className="w-full max-w-sm bg-white rounded-xl shadow-2xl overflow-hidden fade-in">
                        <div className="bg-red-600 p-6 text-center">
                            <i className="fas fa-user-shield text-4xl text-white mb-2"></i>
                            <h2 className="text-xl font-bold text-white tracking-wider">RESTRICTED ACCESS</h2>
                            <p className="text-red-100 text-xs mt-1">Authorized Personnel Only</p>
                        </div>
                        <div className="p-8">
                            <form onSubmit={handleSubmit} className="space-y-4">
                                <div>
                                    <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Access Code</label>
                                    <input 
                                        type="password" 
                                        value={password}
                                        onChange={(e) => {setPassword(e.target.value); setError(false);}}
                                        className="w-full px-4 py-3 rounded-lg border border-slate-300 focus:outline-none focus:ring-2 focus:ring-red-500 text-slate-800 placeholder-slate-400 bg-slate-50"
                                        placeholder="Enter Admin PIN"
                                        autoFocus
                                    />
                                </div>
                                {error && <p className="text-red-500 text-xs font-bold text-center animate-pulse">Access Denied: Invalid PIN</p>}
                                <button type="submit" className="w-full bg-slate-900 hover:bg-slate-800 text-white font-bold py-3 rounded-lg shadow-md transition-all active:scale-95">
                                    LOGIN
                                </button>
                            </form>
                            <p className="text-center text-[10px] text-slate-400 mt-6">Secure Rescue HQ System v1.0</p>
                        </div>
                    </div>
                </div>
            );
        }

        function App() {
            // Check session storage to keep user logged in on refresh
            const [isLoggedIn, setIsLoggedIn] = useState(() => {
                return sessionStorage.getItem("rescue_auth") === "true";
            });
            
            const [client, setClient] = useState(null);
            const [isConnected, setIsConnected] = useState(false);
            const [alerts, setAlerts] = useState([]);
            const [statusMsg, setStatusMsg] = useState("Connecting...");
            const [activeTab, setActiveTab] = useState('dashboard'); 
            
            const mapRef = useRef(null);
            const mapInstanceRef = useRef(null);
            const markersRef = useRef({});

            // Handle Login Success
            const handleLogin = () => {
                sessionStorage.setItem("rescue_auth", "true");
                setIsLoggedIn(true);
            };

            // Handle Logout
            const handleLogout = () => {
                sessionStorage.removeItem("rescue_auth");
                setIsLoggedIn(false);
                if (client && client.isConnected()) client.disconnect();
            };

            // --- MQTT SETUP (Only runs if logged in) ---
            useEffect(() => {
                if (!isLoggedIn) return; // Don't connect if not logged in

                const clientId = "RescueHQ-Pro-" + Math.random().toString(16).substr(2, 8);
                const mqttClient = new Paho.MQTT.Client(MQTT_BROKER, MQTT_PORT, clientId);

                mqttClient.onConnectionLost = (res) => {
                    if (res.errorCode !== 0) {
                        setStatusMsg("OFFLINE");
                        setIsConnected(false);
                    }
                };

                mqttClient.onMessageArrived = (msg) => {
                    const topic = msg.destinationName;
                    try {
                        const data = JSON.parse(msg.payloadString);
                        if (topic === TOPIC_ALERT) handleNewAlert(data);
                        else if (topic === TOPIC_SYNC) handleSync(data);
                    } catch (e) { console.log("Parsing error", e); }
                };

                mqttClient.connect({
                    onSuccess: () => {
                        setIsConnected(true);
                        setStatusMsg("ONLINE");
                        mqttClient.subscribe(TOPIC_ALERT);
                        mqttClient.subscribe(TOPIC_SYNC);
                    },
                    onFailure: (e) => setStatusMsg("ERROR"),
                    useSSL: true
                });

                setClient(mqttClient);
                return () => { if(mqttClient.isConnected()) mqttClient.disconnect(); }
            }, [isLoggedIn]); // Re-run when login state changes

            const handleNewAlert = (data) => {
                let currentStatus = data.status || 'CRITICAL';
                if (data.lat === 0 && data.lon === 0) currentStatus = 'NO_GPS';

                const newAlert = {
                    ...data,
                    status: currentStatus,
                    time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})
                };

                setAlerts(prev => {
                    const existing = prev.filter(a => a.id !== newAlert.id);
                    return [newAlert, ...existing];
                });

                updateMap(newAlert);
            };

            const handleSync = (data) => {
                if (data.type === 'STATUS_UPDATE') {
                    setAlerts(prev => prev.map(a => {
                        if (a.id === data.id) return { ...a, status: data.status };
                        return a;
                    }));
                }
            };

            const updateMap = (alertData) => {
                if (!mapInstanceRef.current) return;
                if (alertData.status === 'NO_GPS') return;

                const { id, lat, lon, status } = alertData;
                
                if (markersRef.current[id]) {
                    mapInstanceRef.current.removeLayer(markersRef.current[id]);
                }

                const marker = L.marker([lat, lon], { icon: createCustomIcon(status) })
                    .addTo(mapInstanceRef.current)
                    .bindPopup(`<b>${id}</b><br>${status}<br>${alertData.time}`);
                
                markersRef.current[id] = marker;
            };

            // --- MAP INIT ---
            useEffect(() => {
                if (isLoggedIn && !mapInstanceRef.current && mapRef.current) {
                    const map = L.map(mapRef.current).setView([4.2105, 101.9758], 6);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '&copy; OpenStreetMap'
                    }).addTo(map);
                    mapInstanceRef.current = map;
                }
                
                if (mapInstanceRef.current) {
                    setTimeout(() => { mapInstanceRef.current.invalidateSize(); }, 200);
                }
            }, [activeTab, isLoggedIn]);

            // --- ACTIONS ---
            const sendAck = (targetId) => {
                if (!client) return;
                const message = new Paho.MQTT.Message("CONFIRM_HELP");
                message.destinationName = TOPIC_RESPONSE;
                client.send(message);
                const syncData = JSON.stringify({ type: 'STATUS_UPDATE', id: targetId, status: 'HELP SENT' });
                const syncMsg = new Paho.MQTT.Message(syncData);
                syncMsg.destinationName = TOPIC_SYNC;
                client.send(syncMsg);
                setAlerts(prev => prev.map(a => a.id === targetId ? { ...a, status: 'HELP SENT' } : a));
                alert(`Confirmation Sent to ${targetId}`);
            };

            const sendMessage = (targetId) => {
                if (!client) return;
                const text = prompt(`Message to ${targetId}:`, "Stay Calm. Help is coming.");
                if (text && text.trim() !== "") {
                    const message = new Paho.MQTT.Message("MSG:" + text);
                    message.destinationName = TOPIC_RESPONSE;
                    client.send(message);
                    alert("Message Sent!");
                }
            };

            const focusMap = (lat, lon) => {
                if (mapInstanceRef.current && lat !== 0) {
                    mapInstanceRef.current.setView([lat, lon], 18);
                    setActiveTab('map'); 
                }
            };

            const getStatusColor = (s) => (s==='NO_GPS'?'border-gray-300 bg-gray-50':s==='LAST_KNOWN'?'border-orange-300 bg-orange-50':s==='HELP SENT'?'border-green-400 bg-green-50':'border-red-400 bg-red-50');
            const getBadgeColor = (s) => (s==='NO_GPS'?'bg-gray-600':s==='LAST_KNOWN'?'bg-orange-500':s==='HELP SENT'?'bg-green-600':'bg-red-600');

            // --- RENDER ---
            
            // 1. Show Login Screen if not authenticated
            if (!isLoggedIn) {
                return <LoginScreen onLogin={handleLogin} />;
            }

            // 2. Show Main App if authenticated
            return (
                <div className="flex flex-col h-full w-full bg-slate-100">
                    
                    {/* NAVBAR */}
                    <div className="bg-slate-900 text-white h-14 md:h-16 flex items-center justify-between px-4 md:px-6 shadow-lg z-20 shrink-0">
                        <div className="flex items-center gap-3">
                            <i className="fas fa-satellite-dish text-red-500 text-xl animate-pulse"></i>
                            <h1 className="text-lg font-bold tracking-wider">RESCUE HQ <span className="hidden md:inline text-xs text-slate-400 font-normal ml-2">COMMAND CENTER</span></h1>
                        </div>
                        <div className="flex items-center gap-3 text-xs font-mono">
                            <div className={`flex items-center gap-2 px-2 py-1 rounded border ${isConnected ? 'border-green-700 bg-green-900/30 text-green-400' : 'border-red-700 bg-red-900/30 text-red-400'}`}>
                                <div className={`w-2 h-2 rounded-full ${isConnected ? 'bg-green-400' : 'bg-red-400'}`}></div>
                                <span>{statusMsg}</span>
                            </div>
                            {/* Logout Button */}
                            <button onClick={handleLogout} className="text-slate-400 hover:text-white ml-2" title="Logout">
                                <i className="fas fa-sign-out-alt text-lg"></i>
                            </button>
                        </div>
                    </div>

                    {/* MAIN CONTENT AREA */}
                    <div className="flex-1 flex overflow-hidden relative">
                        
                        {/* LEFT SIDEBAR: INCIDENT LIST */}
                        <div className={`
                            ${activeTab === 'dashboard' ? 'flex' : 'hidden'} 
                            md:flex w-full md:w-96 flex-col bg-white border-r border-gray-200 z-10 h-full shadow-xl
                        `}>
                            <div className="p-4 bg-white border-b border-gray-100 flex justify-between items-center shrink-0">
                                <h2 className="font-bold text-slate-700 text-sm"><i className="fas fa-list-ul mr-2 text-slate-400"></i>INCIDENTS</h2>
                                <span className="bg-slate-100 text-slate-600 text-xs font-bold px-2 py-1 rounded-full border border-slate-200">{alerts.length}</span>
                            </div>
                            
                            <div className="flex-1 overflow-y-auto p-2 space-y-3 bg-slate-50 no-scrollbar pb-24 md:pb-4">
                                {alerts.length === 0 ? (
                                    <div className="flex flex-col items-center justify-center h-64 text-gray-400">
                                        <div className="bg-gray-100 p-4 rounded-full mb-3"><i className="fas fa-shield-alt text-3xl"></i></div>
                                        <p className="text-sm font-medium">System Standing By</p>
                                        <p className="text-xs">Waiting for signals...</p>
                                    </div>
                                ) : (
                                    alerts.map(alert => (
                                        <div key={alert.id} className={`border-l-4 rounded-lg bg-white p-3 shadow-sm fade-in ${getStatusColor(alert.status)}`}>
                                            <div className="flex justify-between items-start mb-2">
                                                <div>
                                                    <h3 className="font-bold text-base text-slate-800 flex items-center gap-2">
                                                        {alert.id}
                                                        {alert.status === 'NO_GPS' && <i className="fas fa-exclamation-triangle text-red-500 text-xs" title="No GPS"></i>}
                                                    </h3>
                                                    <p className="text-xs text-slate-400 font-mono flex items-center gap-1"><i className="far fa-clock"></i> {alert.time}</p>
                                                </div>
                                                <span className={`px-2 py-0.5 rounded text-[10px] font-bold text-white uppercase ${getBadgeColor(alert.status)}`}>
                                                    {alert.status.replace('_', ' ')}
                                                </span>
                                            </div>

                                            {alert.status !== 'NO_GPS' ? (
                                                <div className="text-xs text-slate-600 mb-3 bg-slate-50 p-2 rounded border border-slate-100 font-mono flex justify-between">
                                                    <span>Lat: {alert.lat.toFixed(5)}</span>
                                                    <span>Lon: {alert.lon.toFixed(5)}</span>
                                                </div>
                                            ) : (
                                                <div className="text-xs text-red-600 mb-3 bg-red-50 p-2 rounded border border-red-100 font-bold text-center">
                                                    GPS DATA UNAVAILABLE
                                                </div>
                                            )}

                                            <div className="grid grid-cols-3 gap-2">
                                                <button onClick={() => focusMap(alert.lat, alert.lon)} disabled={alert.status === 'NO_GPS'} 
                                                    className="flex flex-col items-center justify-center bg-white border border-slate-200 hover:bg-slate-50 text-slate-600 py-2 rounded text-[10px] font-bold transition disabled:opacity-50">
                                                    <i className="fas fa-crosshairs text-sm mb-1"></i> LOCATE
                                                </button>
                                                
                                                <button onClick={() => sendMessage(alert.id)} 
                                                    className="flex flex-col items-center justify-center bg-blue-50 border border-blue-200 hover:bg-blue-100 text-blue-600 py-2 rounded text-[10px] font-bold transition">
                                                    <i className="fas fa-comment-dots text-sm mb-1"></i> MSG
                                                </button>
                                                
                                                {/* --- CHANGED BUTTON --- */}
                                                <button onClick={() => sendAck(alert.id)} 
                                                    className="flex flex-col items-center justify-center bg-green-50 border border-green-200 hover:bg-green-100 text-green-600 py-2 rounded text-[10px] font-bold transition">
                                                    <i className="fas fa-check-double text-sm mb-1"></i> CONFIRM
                                                </button>
                                            </div>
                                            
                                            {alert.status !== 'NO_GPS' && (
                                                <a href={`https://www.google.com/maps/dir/?api=1&destination=${alert.lat},${alert.lon}`} target="_blank" className="block text-center text-[10px] text-blue-400 mt-2 hover:text-blue-600 hover:underline">
                                                    Open in Google Maps <i className="fas fa-external-link-alt ml-1"></i>
                                                </a>
                                            )}
                                        </div>
                                    ))
                                )}
                            </div>
                        </div>

                        {/* RIGHT MAIN: MAP AREA */}
                        <div className={`
                            ${activeTab === 'map' ? 'flex' : 'hidden'} 
                            md:flex flex-1 relative bg-slate-200 h-full w-full
                        `}>
                            <div ref={mapRef} id="map" className="h-full w-full"></div>
                            
                            {/* MOBILE BACK BUTTON */}
                            <button onClick={() => setActiveTab('dashboard')} className="md:hidden absolute top-4 left-4 z-[1000] bg-white text-slate-700 px-3 py-2 rounded shadow-md text-xs font-bold border border-slate-200 flex items-center gap-2 active:scale-95 transition-transform">
                                <i className="fas fa-arrow-left"></i> BACK
                            </button>
                            
                            {/* Legend */}
                            <div className="absolute bottom-20 md:bottom-6 right-4 md:right-6 bg-white/90 backdrop-blur p-3 rounded-lg shadow-lg z-[1000] text-xs border border-gray-200">
                                <div className="font-bold mb-2 text-slate-700 border-b pb-1">MAP LEGEND</div>
                                <div className="flex items-center gap-2 mb-1"><span className="w-2 h-2 rounded-full bg-red-600 shadow-sm"></span> Critical Alert</div>
                                <div className="flex items-center gap-2 mb-1"><span className="w-2 h-2 rounded-full bg-orange-500 shadow-sm"></span> Last Known</div>
                                <div className="flex items-center gap-2"><span className="w-2 h-2 rounded-full bg-green-600 shadow-sm"></span> Help Sent</div>
                            </div>
                        </div>

                    </div>

                    {/* BOTTOM NAV BAR */}
                    <div className="md:hidden bg-white border-t border-slate-200 flex justify-around py-2 pb-5 shadow-[0_-4px_10px_rgba(0,0,0,0.05)] z-30 shrink-0">
                        <button onClick={() => setActiveTab('dashboard')} className={`flex flex-col items-center w-full py-1 ${activeTab === 'dashboard' ? 'text-blue-600' : 'text-slate-400'}`}>
                            <i className="fas fa-list-ul text-xl mb-1"></i>
                            <span className="text-[10px] font-bold">ALERTS</span>
                        </button>
                        
                        <button onClick={() => setActiveTab('map')} className={`flex flex-col items-center w-full py-1 ${activeTab === 'map' ? 'text-blue-600' : 'text-slate-400'}`}>
                            <i className="fas fa-map-marked-alt text-xl mb-1"></i>
                            <span className="text-[10px] font-bold">MAP</span>
                        </button>
                        
                        <button onClick={() => alert("System: OPERATIONAL\nGateway: CONNECTED")} className="flex flex-col items-center w-full py-1 text-slate-400">
                            <i className="fas fa-server text-xl mb-1"></i>
                            <span className="text-[10px] font-bold">SYS</span>
                        </button>
                    </div>

                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
